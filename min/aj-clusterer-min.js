if(!self._)throw"underscore.js not loaded";_.isUndefined(self.aj)&&(aj={}),_.isUndefined(self.aj.geometry)&&(aj.geometry={}),aj.geometry.Clusterer=function(e,t,s,i,r){var a=this;this.map=e,this.workerURL=s,this.geometryURL=i,this.underscoreURL=r,this.delegate=t,this.worker=null,this.cnv=document.createElement("canvas"),this.liveMarkers=[],this.ceilValue=1e4,this.minClusterSize=25,this.maxClusterSize=50,this.clusterLineWidth=2,this.ctx=this.cnv.getContext("2d"),google.maps.event.addDomListener(e,"zoom_changed",function(){a.redraw()}),google.maps.event.addDomListener(e,"dragend",function(){a.redraw()}),this.onmessageFn=function(t){_.each(a.liveMarkers,function(e){e.setMap(null)}),a.liveMarkers=[],_.each(t.data.clusters,function(t){var s=new google.maps.Marker({position:t.position,draggable:!1,map:e}),i=t.markers.length;if(i>1){var r;r=i>=a.ceilValue?-100:Math.floor(220-300/Math.log(a.ceilValue)*Math.log(i));var n;n=i>=a.ceilValue?a.maxClusterSize:Math.floor(a.minClusterSize+(a.maxClusterSize-a.minClusterSize)/Math.log(a.ceilValue)*Math.log(i)),a.cnv.width=n,a.cnv.height=n;var o=n/2,l=n/2;a.ctx.clearRect(0,0,n,n),a.ctx.beginPath(),a.ctx.arc(o,l,n/2-a.clusterLineWidth/2,0,2*Math.PI,!1),a.ctx.fillStyle="hsla("+r+", 50%, 70%, 0.7)",a.ctx.fill(),a.ctx.strokeStyle="hsla("+r+", 50%, 20%, 0.7)",a.ctx.lineWidth=a.clusterLineWidth,a.ctx.stroke(),a.ctx.fillStyle="rgb(0,0,0)",a.ctx.textAlign="center",a.ctx.font="bold 9pt Arial",a.ctx.textBaseline="middle",a.ctx.fillText(i,o,l),s.setIcon(a.cnv.toDataURL())}google.maps.event.addListener(s,"click",function(){a.delegate&&a.delegate.didSelectCluster(a,t,s)}),a.liveMarkers.push(s)})},this.addCoordinates=function(e){var t={command:"add-coordinates",payload:{coordinates:e}};this.worker.postMessage(t),this.redraw()},this.setClusterDistance=function(e){var t={command:"set-cluster-distance",payload:{distance:e}};this.worker.postMessage(t),this.redraw()},this.setMinClusterSize=function(e){this.minClusterSize=e,this.redraw()},this.setMaxClusterSize=function(e){this.maxClusterSize=e,this.redraw()},this.redraw=function(){var e=this.map.getBounds();_.isUndefined(e)?google.maps.event.addListenerOnce(this.map,"idle",function(){a.redraw()}):this.worker.postMessage({command:"get-clusters",payload:{zoomLevel:this.map.getZoom(),swLatitude:e.getSouthWest().lat(),swLongitude:e.getSouthWest().lng(),neLatitude:e.getNorthEast().lat(),neLongitude:e.getNorthEast().lng()}})},this.clear=function(){this.worker&&this.worker.terminate(),this.worker=new Worker(this.workerURL),this.worker.onmessage=this.onmessageFn,this.worker.postMessage({command:"init",payload:{geometryURL:this.geometryURL,underscoreURL:this.underscoreURL}}),this.redraw()},this.clear()};