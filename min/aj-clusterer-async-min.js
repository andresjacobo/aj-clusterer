var treeDepth=20,runloopClusterIterations=1e3,clusterCounter=0,commandCounter=0,currentZoomLevel=-1,currentClusterDistance=100,clusters=null,markers=null;onmessage=function(e){var t=e.data.command,r=e.data.payload;if(commandCounter++,"init"===t)importScripts(r.underscoreURL,r.geometryURL),markers=new aj.geometry.QuadTree(treeDepth,new aj.geometry.TreeNode(new aj.geometry.Rect(new aj.geometry.Point(0,0),new aj.geometry.Size(256,256))));else if("add-coordinates"===t)_.each(r.coordinates,function(e){var t=new aj.geometry.Coordinate(e[0],e[1]),r=getWorldPositionForCoordinate(t),o=new aj.geometry.Marker(t,r,-1,e[2]);markers.insertItem(o,r)});else if("set-cluster-distance"===t)currentClusterDistance=r.distance,currentZoomLevel=-1;else if("get-clusters"===t){r.zoomLevel!==currentZoomLevel&&(clusterCounter++,currentZoomLevel=r.zoomLevel,clusters=new aj.geometry.QuadTree(treeDepth,new aj.geometry.TreeNode(new aj.geometry.Rect(new aj.geometry.Point(0,0),new aj.geometry.Size(256,256)))));var o,n=getWorldPositionForCoordinate(new aj.geometry.Coordinate(r.swLatitude,r.swLongitude)),a=getWorldPositionForCoordinate(new aj.geometry.Coordinate(r.neLatitude,r.neLongitude)),s=1<<currentZoomLevel,i=currentClusterDistance/s;if(n.x=Math.max(0,n.x-i),n.y=Math.min(256,n.y+i),a.x=Math.min(256,a.x+i),a.y=Math.max(0,a.y-i),n.x>a.x){var u=new aj.geometry.Rect(new aj.geometry.Point(n.x,a.y),new aj.geometry.Size(256-n.x,n.y-a.y)),l=new aj.geometry.Rect(new aj.geometry.Point(0,a.y),new aj.geometry.Size(a.x,n.y-a.y));o=markers.findItemsInRect(u),o=o.concat(markers.findItemsInRect(l)),recursivelyGetClusters(o,[u,l],i,commandCounter,0)}else{var c=new aj.geometry.Rect(new aj.geometry.Point(n.x,a.y),new aj.geometry.Size(a.x-n.x,n.y-a.y));o=markers.findItemsInRect(c),recursivelyGetClusters(o,[c],i,commandCounter,0)}}},recursivelyGetClusters=function(e,t,r,o,n){if(o===commandCounter){var a=e.slice(n,n+runloopClusterIterations);if(_.each(a,function(e){if(e.clusterCounter!==clusterCounter){var t=getClosestClusterForMarker(e,r);_.isNull(t)?(t=new aj.geometry.Cluster([e]),clusters.insertItem(t,t.worldPosition)):t.markers.push(e),e.clusterCounter=clusterCounter}}),a.length==runloopClusterIterations)setTimeout(function(){recursivelyGetClusters(e,t,r,o,n+runloopClusterIterations)},0);else{var s=[];_.each(t,function(e){s=s.concat(clusters.findItemsInRect(e))}),self.postMessage({clusters:s})}}},getClosestClusterForMarker=function(e,t){var r=null,o=Number.POSITIVE_INFINITY,n=new aj.geometry.Point(e.worldPosition.x-t/2,e.worldPosition.y-t/2),a=new aj.geometry.Size(t,t),s=clusters.findItemsInRect(new aj.geometry.Rect(n,a));return _.each(s,function(t){var n=getApproxDistanceBetweenPoints(t.worldPosition,e.worldPosition);o>n&&(r=t,o=n)}),r},getApproxDistanceBetweenPoints=function(e,t){return Math.pow(e.y-t.y,2)+Math.pow(e.x-t.x,2)},getWorldPositionForCoordinate=function(e){var t=256,r=256,o=(e.lng+180)*(t/360),n;if(e.lat>85)n=0;else if(e.lat<-85)n=r;else{var a=e.lat*Math.PI/180;n=Math.log(Math.tan(a/2+Math.PI/4)),n=r/2-t*n/(2*Math.PI)}return new aj.geometry.Point(o,n)};